<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–ª–∞–Ω –î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞ 2026</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0984e3">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2910/2910768.png">

    <style>
        /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è (–í–∞—à –∫—Ä–∞—Å–∏–≤—ã–π –¥–∏–∑–∞–π–Ω) */
        :root {
            --bg-color: #f0f2f5; --card-bg: #ffffff; --text-main: #2d3436; --text-sec: #636e72; --accent: #0984e3;
            --wait: #b2bec3; --work: #fdcb6e; --today: #d63031; --done: #00b894; --archive: #636e72;
        }

        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: var(--bg-color); margin: 0; padding: 20px; color: var(--text-main); -webkit-tap-highlight-color: transparent; }
        .container { max-width: 1200px; margin: 0 auto; padding-bottom: 80px; }
        
        .header { background: var(--card-bg); padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .h-title { font-size: 24px; font-weight: 800; color: #2c3e50; }
        .h-subtitle { font-size: 14px; color: var(--text-sec); margin-top: 5px; }
        .h-date { font-size: 18px; color: var(--accent); font-weight: 600; text-align: right; }

        .controls { margin-bottom: 20px; overflow-x: auto; white-space: nowrap; padding-bottom: 10px; scrollbar-width: none; }
        .filter-btn { border: none; background: white; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: 600; color: var(--text-sec); box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-right: 10px; transition: 0.2s; font-size: 13px; }
        .filter-btn.active { background: var(--accent); color: white; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(9, 132, 227, 0.3); }
        .filter-btn.archive-btn { background: #dfe6e9; color: #636e72; border: 1px solid #b2bec3; }
        .filter-btn.archive-btn.active { background: #636e72; color: white; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        
        .card { background: var(--card-bg); border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.04); transition: transform 0.2s; border-left: 6px solid transparent; display: flex; flex-direction: column; position: relative; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .card-cat { font-size: 11px; font-weight: 700; text-transform: uppercase; color: #95a5a6; margin-bottom: 8px; }
        .card-title { font-size: 16px; font-weight: 700; margin-bottom: 15px; line-height: 1.4; color: #2d3436; }
        
        .timeline { display: flex; align-items: center; justify-content: space-between; background: #f8f9fa; padding: 10px; border-radius: 8px; font-size: 12px; color: #636e72; margin-bottom: 15px; border: 1px solid #eee; }
        .t-point { display: flex; flex-direction: column; }
        .t-label { font-size: 10px; text-transform: uppercase; color: #b2bec3; }
        .t-val { font-weight: 700; color: #2d3436; }
        .t-arrow { color: #dfe6e9; font-size: 18px; }

        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 800; text-transform: uppercase; color: white; }
        .btn { text-decoration: none; text-align: center; background-color: #2d3436; color: white; padding: 12px; border-radius: 8px; font-weight: 600; transition: 0.2s; display: block; margin-top: auto; font-size: 14px; }
        .btn:hover { background-color: var(--accent); }

        .st-wait { border-left-color: var(--wait); } .bg-wait { background: var(--wait); color: white; }
        .st-work { border-left-color: var(--work); } .bg-work { background: var(--work); color: #2d3436; }
        .st-today { border-left-color: var(--today); } .bg-today { background: var(--today); color: white; box-shadow: 0 0 10px rgba(214, 48, 49, 0.4); }
        .st-done { border-left-color: var(--done); } .bg-done { background: var(--done); color: white; }
        .st-archive { border-left-color: var(--archive); opacity: 0.8; } .bg-archive { background: var(--archive); color: white; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(3px); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background-color: #fff; padding: 30px; border-radius: 16px; width: 90%; max-width: 450px; text-align: center; box-shadow: 0 15px 35px rgba(0,0,0,0.2); animation: slideUp 0.3s ease-out; }
        .modal-list { text-align: left; background: #fff5f5; padding: 15px; border-radius: 10px; border-left: 4px solid var(--today); margin-bottom: 20px; max-height: 250px; overflow-y: auto; }
        .close-btn { background-color: var(--accent); color: white; border: none; padding: 14px; font-size: 15px; border-radius: 10px; cursor: pointer; width: 100%; }

        #installContainer { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 1000; display: none; }
        .install-btn { background: #2d3436; color: white; border: none; padding: 14px 28px; border-radius: 50px; font-weight: bold; box-shadow: 0 10px 25px rgba(0,0,0,0.3); cursor: pointer; display: flex; align-items: center; gap: 10px; }
    </style>
</head>
<body>

<div id="notificationModal" class="modal-overlay">
    <div class="modal-content">
        <span style="font-size: 40px;">üî•</span>
        <div style="font-size: 20px; font-weight: 800; margin: 15px 0;">–°–ï–ì–û–î–ù–Ø –ü–£–ë–õ–ò–ö–ê–¶–ò–Ø</div>
        <div class="modal-list" id="modalListContent"></div>
        <button class="close-btn" onclick="closeModal()">–ü—Ä–∏–Ω—è—Ç–æ</button>
    </div>
</div>

<div class="container">
    <div class="header">
        <div>
            <div class="h-title">–ü–ª–∞–Ω –î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞</div>
            <div class="h-subtitle">–ï–¥–∏–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (–ü–ª–∞–Ω + –ü—É–±–ª–∏–∫–∞—Ü–∏–∏)</div>
        </div>
        <div class="h-date" id="currentDate"></div>
    </div>

    <div class="controls" id="categoryFilters"></div>
    <div id="loader" style="text-align: center; padding: 40px; color: #636e72;">üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    <div class="grid" id="dashboardGrid"></div>
</div>

<div id="installContainer">
    <button class="install-btn" onclick="installPWA()">üì≤ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</button>
</div>

<script>
    // === –°–°–´–õ–ö–ò –ù–ê –í–ê–®–ò CSV –§–ê–ô–õ–´ ===
    const URL_SHEET_PLAN = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSSiUUHVFLpn5WE5zwI7UOCNNz4gjENAX4ahMtDO7f8e_qvUpwTqtaBN0nfUzOU5unXMWvzwU5zhSkB/pub?gid=0&single=true&output=csv';
    
    const URL_SHEET_LINKS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSSiUUHVFLpn5WE5zwI7UOCNNz4gjENAX4ahMtDO7f8e_qvUpwTqtaBN0nfUzOU5unXMWvzwU5zhSkB/pub?gid=947799784&single=true&output=csv';

    const DEFAULT_LINK = "https://stat.gov.kz/ru/region/astana/spreadsheets/";
    const ARCHIVE_THRESHOLD = new Date(2023, 0, 1);
    const CURRENT_PLAN_YEAR = 2026;

    let allData = [];
    const now = new Date();
    document.getElementById('currentDate').innerText = now.toLocaleDateString('ru-RU', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

    async function loadAllData() {
        try {
            const [planRes, linksRes] = await Promise.all([
                fetch(URL_SHEET_PLAN),
                fetch(URL_SHEET_LINKS)
            ]);

            const planText = await planRes.text();
            const linksText = await linksRes.text();

            const planItems = parsePlanSheet(planText);
            const linkItems = parseLinksSheet(linksText);

            allData = [...planItems, ...linkItems];

            document.getElementById('loader').style.display = 'none';
            generateFilters();
            renderCards('all'); 
            checkNotifications();

        } catch (error) {
            document.getElementById('loader').innerHTML = `‚ö†Ô∏è <b>–û—à–∏–±–∫–∞:</b> –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.`;
        }
    }

    // –ü–∞—Ä—Å–µ—Ä –õ–∏—Å—Ç–∞ 1 (–ü–ª–∞–Ω)
    function parsePlanSheet(text) {
        const rows = text.split('\n');
        let currentCategory = "–ü–ª–∞–Ω";
        let items = [];

        rows.forEach((rowRaw, index) => {
            if (index === 0) return;
            const cols = rowRaw.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            let name = cols[0]?.replace(/"/g, '').trim(); 
            let startRaw = cols[1]?.replace(/"/g, '').trim(); 
            let endRaw = cols[2]?.replace(/"/g, '').trim();
            
            if (!name) return;
            if (!startRaw && !endRaw) { currentCategory = name; return; }

            const startDate = parseRusDateSmart(startRaw);
            const endDate = parseRusDateSmart(endRaw);

            if (endDate) {
                items.push({
                    type: 'plan',
                    name: name,
                    category: currentCategory,
                    start: startDate,
                    end: endDate,
                    startTxt: startRaw || "‚Äî",
                    endTxt: endRaw,
                    link: DEFAULT_LINK, 
                    isArchive: false
                });
            }
        });
        return items;
    }

    // –ü–∞—Ä—Å–µ—Ä –õ–∏—Å—Ç–∞ 2 (–°—Å—ã–ª–∫–∏)
    function parseLinksSheet(text) {
        const rows = text.split('\n');
        let currentCategory = "–ü—É–±–ª–∏–∫–∞—Ü–∏–∏";
        let items = [];

        rows.forEach((rowRaw, index) => {
            if (index === 0) return;
            const cols = rowRaw.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            // A=Name, B=Date, C=Link, D=Comment
            let name = cols[0]?.replace(/"/g, '').trim(); 
            let dateRaw = cols[1]?.replace(/"/g, '').trim(); 
            let link = cols[2]?.replace(/"/g, '').trim();
            let comment = cols[3]?.replace(/"/g, '').trim();

            if (!name) return;
            if (!dateRaw && !link) { currentCategory = name; return; }

            const releaseDate = parseRusDateSmart(dateRaw);
            
            if (releaseDate) {
                const isArchive = releaseDate < ARCHIVE_THRESHOLD;
                items.push({
                    type: 'link',
                    name: name,
                    category: currentCategory,
                    start: null,
                    end: releaseDate,
                    startTxt: null,
                    endTxt: dateRaw,
                    link: link || DEFAULT_LINK,
                    comment: comment,
                    isArchive: isArchive
                });
            }
        });
        return items;
    }

    // –£–º–Ω–∞—è –¥–∞—Ç–∞ (–∏—â–µ—Ç –≥–æ–¥)
    function parseRusDateSmart(str) {
        if (!str) return null;
        const cleanStr = str.toLowerCase().replace(/[.,]/g, '').trim();
        const parts = cleanStr.split(' ');
        const day = parseInt(parts[0]);
        if (isNaN(day)) return null;

        const monthNames = ["—è–Ω–≤", "—Ñ–µ–≤", "–º–∞—Ä", "–∞–ø—Ä", "–º–∞—è", "–∏—é–Ω", "–∏—é–ª", "–∞–≤–≥", "—Å–µ–Ω", "–æ–∫—Ç", "–Ω–æ—è", "–¥–µ–∫"];
        let monthIndex = -1;
        monthNames.forEach((m, i) => { if (cleanStr.includes(m)) monthIndex = i; });
        if (monthIndex === -1) return null;

        let year = CURRENT_PLAN_YEAR;
        const yearMatch = cleanStr.match(/20\d{2}/); 
        if (yearMatch) year = parseInt(yearMatch[0]);

        return new Date(year, monthIndex, day);
    }

    // –°—Ç–∞—Ç—É—Å
    function getStatus(item) {
        if (item.isArchive) return { code: 'archive', text: '–ê—Ä—Ö–∏–≤ ' + item.end.getFullYear(), class: 'st-archive', badge: 'bg-archive' };
        
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
        const endT = item.end.getTime();

        if (item.type === 'link') {
            if (today >= endT) return { code: 'done', text: '–î–æ—Å—Ç—É–ø–Ω–æ', class: 'st-done', badge: 'bg-done' };
            if (today === endT) return { code: 'today', text: 'üî• –°–ï–ì–û–î–ù–Ø', class: 'st-today', badge: 'bg-today' };
            return { code: 'wait', text: '–°–∫–æ—Ä–æ', class: 'st-wait', badge: 'bg-wait' };
        }

        const startT = item.start ? item.start.getTime() : null;
        if (today > endT) return { code: 'done', text: '–ó–∞–≤–µ—Ä—à–µ–Ω–æ', class: 'st-done', badge: 'bg-done' };
        if (today === endT) return { code: 'today', text: 'üî• –°–ï–ì–û–î–ù–Ø', class: 'st-today', badge: 'bg-today' };
        if (startT && today >= startT && today < endT) return { code: 'work', text: '–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ', class: 'st-work', badge: 'bg-work' };
        return { code: 'wait', text: '–°–∫–æ—Ä–æ', class: 'st-wait', badge: 'bg-wait' };
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
    function renderCards(filterMode) {
        const grid = document.getElementById('dashboardGrid');
        grid.innerHTML = '';

        let filtered = [];
        if (filterMode === 'archive') filtered = allData.filter(item => item.isArchive);
        else if (filterMode === 'all') filtered = allData.filter(item => !item.isArchive);
        else filtered = allData.filter(item => item.category === filterMode && !item.isArchive);

        const priority = { 'today': 1, 'work': 2, 'wait': 3, 'done': 4, 'archive': 5 };
        
        filtered.sort((a, b) => {
            if (filterMode === 'archive') return b.end - a.end;
            const statA = getStatus(a).code;
            const statB = getStatus(b).code;
            if (priority[statA] !== priority[statB]) return priority[statA] - priority[statB];
            return a.end - b.end;
        });

        if (filtered.length === 0) {
            grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #999;">–í —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ –ø—É—Å—Ç–æ</div>';
            return;
        }

        filtered.forEach(item => {
            const s = getStatus(item);
            const commentHTML = item.comment ? 
                `<div style="background:#fff9db; color:#d35400; padding:8px; border-radius:6px; font-size:12px; margin-bottom:10px; border-left:3px solid #f1c40f;"><b>–ü—Ä–∏–º:</b> ${item.comment}</div>` : '';

            let timelineHTML = '';
            let btnText = '';

            if (item.type === 'plan') {
                timelineHTML = `
                    <div class="timeline">
                        <div class="t-point"><span class="t-label">–ù–∞—á–∞–ª–æ</span><span class="t-val">${item.startTxt}</span></div>
                        <div class="t-arrow">‚ûù</div>
                        <div class="t-point" style="text-align: right;"><span class="t-label">–°—Ä–æ–∫</span><span class="t-val">${item.endTxt}</span></div>
                    </div>`;
                btnText = '–ü–µ—Ä–µ–π—Ç–∏ –∫ —Ä–∞–∑–¥–µ–ª—É';
            } else {
                timelineHTML = `
                    <div class="timeline" style="justify-content: center;">
                        <div class="t-point" style="align-items: center;"><span class="t-label">–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</span><span class="t-val">${item.endTxt}</span></div>
                    </div>`;
                btnText = item.isArchive ? 'üìÇ –°–∫–∞—á–∞—Ç—å –∞—Ä—Ö–∏–≤' : 'üîó –û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª';
            }

            const cardHTML = `
                <div class="card ${s.class}">
                    <div>
                        <div class="card-header">
                            <div><span class="card-cat">${item.category}</span></div>
                            <span class="status-badge ${s.badge}">${s.text}</span>
                        </div>
                        <div class="card-title">${item.name}</div>
                        ${timelineHTML}
                        ${commentHTML}
                    </div>
                    <a href="${item.link}" target="_blank" class="btn">${btnText}</a>
                </div>
            `;
            grid.innerHTML += cardHTML;
        });
    }

    function generateFilters() {
        const cats = [...new Set(allData.filter(i => !i.isArchive).map(i => i.category))];
        const container = document.getElementById('categoryFilters');
        let html = '<button class="filter-btn active" onclick="filterData(\'all\')">–í—Å–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ</button>';
        cats.forEach(cat => { if(cat) html += `<button class="filter-btn" onclick="filterData('${cat}')">${cat}</button>`; });
        html += `<button class="filter-btn archive-btn" onclick="filterData('archive')">üóÑÔ∏è –ê–†–•–ò–í</button>`;
        container.innerHTML = html;
    }

    window.filterData = function(mode) {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        renderCards(mode);
    }

    function checkNotifications() {
        const todayItems = allData.filter(item => getStatus(item).code === 'today' && !item.isArchive);
        if (todayItems.length > 0) {
            document.getElementById('modalListContent').innerHTML = "<ul>" + todayItems.map(i => `<li>${i.name}</li>`).join('') + "</ul>";
            document.getElementById('notificationModal').style.display = 'flex';
        }
    }
    window.closeModal = function() { document.getElementById('notificationModal').style.display = 'none'; }

    let deferredPrompt;
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; document.getElementById('installContainer').style.display = 'block'; });
    window.installPWA = async function() { if (deferredPrompt) { deferredPrompt.prompt(); const { outcome } = await deferredPrompt.userChoice; if (outcome === 'accepted') document.getElementById('installContainer').style.display = 'none'; } }

    loadAllData();
</script>
</body>
</html>